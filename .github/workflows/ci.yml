name: CI

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '23.x'
  CACHE_KEY_PREFIX: 'cisv-v2'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-keys.outputs.node }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'bindings/nodejs/package-lock.json'

      - name: Generate cache keys
        id: cache-keys
        run: echo "node=${{ env.CACHE_KEY_PREFIX }}-node-${{ hashFiles('bindings/nodejs/package-lock.json') }}" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: |
          cd bindings/nodejs
          npm ci

      - name: Cache node_modules
        uses: actions/cache/save@v5
        with:
          path: bindings/nodejs/node_modules
          key: ${{ steps.cache-keys.outputs.node }}

  npm-tests:
    name: Node.js Tests
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache/restore@v5
        with:
          path: bindings/nodejs/node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Build and test
        run: |
          cd bindings/nodejs
          npm run test:build

  c-tests:
    name: C Core Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache build tools
        uses: actions/cache@v5
        with:
          path: |
            /var/cache/apt
            /usr/include
          key: ${{ env.CACHE_KEY_PREFIX }}-build-tools-${{ runner.os }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake valgrind

      - name: Build and run core tests
        run: |
          make core
          cd core
          make test

  cli-build-test:
    name: CLI Build & Test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache build artifacts
        uses: actions/cache@v5
        with:
          path: |
            core/build/
            cli/build/
          key: ${{ env.CACHE_KEY_PREFIX }}-cli-${{ matrix.os }}-${{ hashFiles('core/**', 'cli/**', 'Makefile') }}

      - name: Build CLI
        run: |
          make clean
          make all

      - name: Test CLI functionality
        run: |
          cat > test.csv << 'EOF'
          id,name,value
          1,test,100
          2,demo,200
          EOF
          LD_LIBRARY_PATH=core/build cli/build/cisv --version
          LD_LIBRARY_PATH=core/build cli/build/cisv --help
          test "$(LD_LIBRARY_PATH=core/build cli/build/cisv -c test.csv | tr -d '[:space:]')" = "3"
          LD_LIBRARY_PATH=core/build cli/build/cisv test.csv
          LD_LIBRARY_PATH=core/build cli/build/cisv -s 0,2 test.csv
          LD_LIBRARY_PATH=core/build cli/build/cisv --head 1 test.csv
          rm -f test.csv

      - name: Upload CLI binary
        uses: actions/upload-artifact@v6
        with:
          name: cisv-cli-${{ matrix.os }}
          path: cli/build/cisv
          retention-days: 7

  memory-check:
    name: Memory Safety Tests
    runs-on: ubuntu-latest
    needs: cli-build-test
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'memory-checks')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install memory checking tools
        run: |
          sudo apt-get update
          sudo apt-get install -y valgrind cppcheck clang-tools

      - name: Build with debug symbols
        run: |
          make clean
          CFLAGS="-g -O0" make all

      - name: Create test data
        run: |
          cat > memtest.csv << 'EOF'
          id,name,value
          1,test,100
          2,demo,200
          EOF

      - name: Run Valgrind tests
        run: |
          export LD_LIBRARY_PATH=core/build
          valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
            --verbose --log-file=valgrind-version.log cli/build/cisv --version
          valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
            --log-file=valgrind-basic.log cli/build/cisv memtest.csv
          valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
            --log-file=valgrind-count.log cli/build/cisv -c memtest.csv
          valgrind --leak-check=full --show-leak-kinds=all --track-origins=yes \
            --log-file=valgrind-select.log cli/build/cisv -s 0,2 memtest.csv

      - name: Check for memory leaks
        run: |
          ! grep -q "definitely lost" valgrind-*.log
          ! grep -q "indirectly lost" valgrind-*.log

      - name: Run deep leak tests
        run: |
          if [ -f scripts/test_select.sh ]; then chmod +x scripts/test_select.sh && bash ./scripts/test_select.sh; fi
          if [ -f scripts/test_transform.sh ]; then chmod +x scripts/test_transform.sh && bash ./scripts/test_transform.sh; fi

      - name: Upload memory check logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: memory-check-logs
          path: valgrind-*.log
          retention-days: 30

  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    needs: [setup, cli-build-test]
    if: |
      github.event_name == 'pull_request' &&
      contains(github.event.pull_request.labels.*.name, 'benchmarks')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules
        uses: actions/cache/restore@v5
        with:
          path: bindings/nodejs/node_modules
          key: ${{ needs.setup.outputs.cache-key }}

      - name: Install dependencies
        run: |
          npm install -g node-gyp
          sudo apt-get update
          sudo apt-get install -y bc time python3 python3-pip php-cli php-dev composer

          # Install Python dependencies for benchmarks
          pip3 install pandas polars pyarrow --quiet || true

          # Install Node.js comparison libraries
          cd bindings/nodejs
          npm install papaparse csv-parse fast-csv csv-parser d3-dsv csv-string --save-dev || true
          cd ../..

          # Install PHP league/csv via composer
          mkdir -p /tmp/csv_bench && cd /tmp/csv_bench
          composer require league/csv --quiet || true
          cd -

      - name: Run benchmarks
        run: |
          export CI=true
          export GITHUB_SHA="${{ github.sha }}"
          export GITHUB_REF_NAME="${{ github.ref_name }}"

          # Install benchmark dependencies (rust-csv, miller, csvkit)
          bash ./scripts/benchmark_cli.sh install 2>&1 | tee install.log

          # Run benchmarks - stdout is markdown, stderr is logs
          bash ./scripts/benchmark_cli.sh benchmark --all > BENCHMARKS.md 2>benchmark.log

          # Show log for debugging
          cat benchmark.log

      - name: Commit and push
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add BENCHMARKS.md
          git commit -m "Update benchmark results [skip ci]" || exit 0
          git push --force origin ${{ github.event.pull_request.head.ref }}

      - name: Comment PR with summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('BENCHMARKS.md')) {
              const content = fs.readFileSync('BENCHMARKS.md', 'utf8');
              // Extract first 50 lines for summary
              const lines = content.split('\n').slice(0, 50);
              let summary = lines.join('\n');
              summary += '\n\n---\n\n';
              summary += '> Full results: [BENCHMARKS.md](../blob/${{ github.head_ref }}/BENCHMARKS.md)\n';
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [npm-tests, c-tests, cli-build-test]
    if: always()
    steps:
      - name: Check job results
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "One or more jobs failed"
            exit 1
          elif [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs were cancelled"
            exit 1
          else
            echo "All CI jobs succeeded"
          fi
