name: Update Packagist

on:
  push:
    branches:
      - master
    paths:
      - 'composer.json'
      - 'bindings/php/**'
  release:
    types: [published]

jobs:
  packagist:
    runs-on: ubuntu-latest
    steps:
      - name: Update Packagist
        env:
          # SECURITY: Use environment variables to prevent credential exposure in logs
          PACKAGIST_USERNAME: ${{ secrets.PACKAGIST_USERNAME }}
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}
        run: |
          # Use API-TOKEN header instead of query string to protect credentials
          curl -sSf -XPOST \
            -H 'Content-Type: application/json' \
            -H "API-TOKEN: ${PACKAGIST_TOKEN}" \
            -d "{\"repository\":{\"url\":\"https://packagist.org/packages/${PACKAGIST_USERNAME}/cisv\"}}" \
            "https://packagist.org/api/update-package"
