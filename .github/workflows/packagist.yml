name: Update Packagist

on:
  push:
    branches:
      - master
    paths:
      - 'composer.json'
      - 'bindings/php/**'
  release:
    types: [published]

jobs:
  packagist:
    runs-on: ubuntu-latest
    steps:
      - name: Update Packagist
        env:
          # SECURITY: Use environment variables to prevent credential exposure in logs
          PACKAGIST_USERNAME: ${{ secrets.PACKAGIST_USERNAME }}
          PACKAGIST_TOKEN: ${{ secrets.PACKAGIST_TOKEN }}
        run: |
          # Packagist API requires username and apiToken as query parameters
          # Repository URL should be the GitHub repo, not the Packagist package URL
          curl -sSf -XPOST \
            -H 'Content-Type: application/json' \
            -d '{"repository":"https://github.com/'"${PACKAGIST_USERNAME}"'/cisv"}' \
            "https://packagist.org/api/update-package?username=${PACKAGIST_USERNAME}&apiToken=${PACKAGIST_TOKEN}"
