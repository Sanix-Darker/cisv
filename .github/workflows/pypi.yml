name: Publish Python Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_to_pypi:
        description: 'Publish to PyPI (true/false)'
        required: true
        default: 'false'

permissions:
  contents: read

env:
  VERSION: ${{ github.ref_type == 'tag' && github.ref_name || '0.0.0.dev0' }}

jobs:
  build-linux-wheel:
    name: Build Linux wheel (x86_64)
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
          python -m pip install --upgrade pip build wheel

      - name: Build core library
        run: |
          cd core
          make clean
          make shared
          ls -la build/
          echo "=== GLIBC symbols required ==="
          objdump -T build/libcisv.so | grep GLIBC | sed 's/.*GLIBC_/GLIBC_/' | sort -u || true

      - name: Set package version from tag
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION="${VERSION#v}"
          echo "Using version: $VERSION"

          sed -i "s/^version = .*/version = \"$VERSION\"/" bindings/python/pyproject.toml
          sed -i "s/__version__ = .*/__version__ = '$VERSION'/" bindings/python/cisv/__init__.py

          grep "version" bindings/python/pyproject.toml
          grep "__version__" bindings/python/cisv/__init__.py

      - name: Prepare Python package
        run: |
          mkdir -p bindings/python/cisv/libs
          cp core/build/libcisv.so bindings/python/cisv/libs/
          cp LICENSE bindings/python/

      - name: Build wheel
        run: |
          cd bindings/python
          python -m build --wheel

          # Tag as manylinux_2_35 (Ubuntu 22.04 glibc version)
          cd dist
          for whl in *.whl; do
            NEW_NAME=$(echo "$whl" | sed "s/-py3-none-any\.whl/-py3-none-manylinux_2_35_x86_64.whl/")
            mv "$whl" "$NEW_NAME"
            echo "Built: $NEW_NAME"
          done
          ls -la

      - name: Upload wheel
        uses: actions/upload-artifact@v6
        with:
          name: wheel-linux-x86_64
          path: bindings/python/dist/*.whl

  build-macos-arm64-wheel:
    name: Build macOS wheel (ARM64)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip build wheel

      - name: Build core library
        run: |
          cd core
          make clean
          make shared
          ls -la build/

      - name: Set package version from tag
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION="${VERSION#v}"
          echo "Using version: $VERSION"

          sed -i '' "s/^version = .*/version = \"$VERSION\"/" bindings/python/pyproject.toml
          sed -i '' "s/__version__ = .*/__version__ = '$VERSION'/" bindings/python/cisv/__init__.py

          grep "version" bindings/python/pyproject.toml
          grep "__version__" bindings/python/cisv/__init__.py

      - name: Prepare Python package
        run: |
          mkdir -p bindings/python/cisv/libs
          cp core/build/libcisv.dylib bindings/python/cisv/libs/
          cp LICENSE bindings/python/

          # Verify the library
          otool -L bindings/python/cisv/libs/libcisv.dylib || true

      - name: Build wheel
        run: |
          cd bindings/python
          python -m build --wheel

          cd dist
          for whl in *.whl; do
            NEW_NAME=$(echo "$whl" | sed "s/-py3-none-any\.whl/-py3-none-macosx_11_0_arm64.whl/")
            mv "$whl" "$NEW_NAME"
            echo "Built: $NEW_NAME"
          done
          ls -la

      - name: Upload wheel
        uses: actions/upload-artifact@v6
        with:
          name: wheel-macos-arm64
          path: bindings/python/dist/*.whl

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: pip install build

      - name: Set package version from tag
        run: |
          VERSION="${{ env.VERSION }}"
          VERSION="${VERSION#v}"
          echo "Using version: $VERSION"

          sed -i "s/^version = .*/version = \"$VERSION\"/" bindings/python/pyproject.toml
          sed -i "s/__version__ = .*/__version__ = '$VERSION'/" bindings/python/cisv/__init__.py

      - name: Prepare sdist with C source code
        run: |
          # Copy LICENSE
          cp LICENSE bindings/python/

          # Clean any pre-built libraries (sdist should only contain source)
          rm -rf bindings/python/cisv/libs/*.so bindings/python/cisv/libs/*.dylib 2>/dev/null || true

          # Copy the core C source code into the Python package directory
          # This allows pip to compile from source
          cp -r core bindings/python/

          # Clean any build artifacts from core
          rm -rf bindings/python/core/build 2>/dev/null || true

          # Verify the structure
          echo "=== Package structure ==="
          ls -la bindings/python/
          ls -la bindings/python/core/

      - name: Build sdist
        run: |
          cd bindings/python
          python -m build --sdist

          # Verify sdist contents
          echo "=== sdist contents ==="
          tar -tzf dist/*.tar.gz | head -50

      - name: Upload sdist
        uses: actions/upload-artifact@v6
        with:
          name: sdist
          path: bindings/python/dist/*.tar.gz

  test-sdist:
    name: Test source distribution
    needs: [build-sdist]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, macos-14]
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          if [[ "${{ matrix.os }}" == ubuntu* ]]; then
            sudo apt-get update
            sudo apt-get install -y build-essential
          fi

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist/

      - name: Install from sdist (compiles from source)
        run: |
          pip install dist/*.tar.gz -v

      - name: Test import and functionality
        run: |
          python -c "import cisv; print(f'cisv version: {cisv.__version__}')"
          python -c "import cisv; print(cisv.parse_string('a,b,c\n1,2,3'))"
          python -c "
          import cisv
          import tempfile
          import os

          with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False) as f:
              f.write('name,value\n')
              for i in range(100):
                  f.write(f'item{i},{i}\n')
              filepath = f.name

          rows = cisv.parse_file(filepath)
          assert len(rows) == 101, f'Expected 101 rows, got {len(rows)}'
          print(f'Parsed {len(rows)} rows from source-built library!')

          os.unlink(filepath)
          print('Source build test passed!')
          "

  test-wheels:
    name: Test wheels
    needs: [build-linux-wheel, build-macos-arm64-wheel]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            artifact: wheel-linux-x86_64
          - os: ubuntu-24.04
            artifact: wheel-linux-x86_64
          - os: macos-14
            artifact: wheel-macos-arm64
          - os: macos-15
            artifact: wheel-macos-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: dist/

      - name: Install wheel
        run: |
          pip install dist/*.whl

      - name: Test import and basic functionality
        run: |
          python -c "import cisv; print(f'cisv version: {cisv.__version__}')"
          python -c "import cisv; print(cisv.parse_string('a,b,c\n1,2,3'))"
          python -c "
          import cisv
          import tempfile
          import os

          # Create test file
          with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False) as f:
              f.write('name,value\n')
              for i in range(1000):
                  f.write(f'item{i},{i}\n')
              filepath = f.name

          # Test parse_file
          rows = cisv.parse_file(filepath)
          assert len(rows) == 1001, f'Expected 1001 rows, got {len(rows)}'
          print(f'Parsed {len(rows)} rows successfully')

          # Test count_rows
          count = cisv.count_rows(filepath)
          assert count == 1001, f'Expected 1001, got {count}'
          print(f'Counted {count} rows successfully')

          os.unlink(filepath)
          print('All tests passed!')
          "

  publish-testpypi:
    name: Publish to TestPyPI
    needs: [build-linux-wheel, build-macos-arm64-wheel, build-sdist, test-wheels]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: List artifacts
        run: ls -la dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          packages-dir: dist/
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          skip-existing: true

  publish-pypi:
    name: Publish to PyPI
    needs: [build-linux-wheel, build-macos-arm64-wheel, build-sdist, test-wheels]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: List artifacts
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
