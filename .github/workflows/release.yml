name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: read
env:
  VERSION: ${{ github.ref_name }}
jobs:
  release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        include:
          - os: ubuntu-latest
            asset_name: linux
          - os: macos-latest
            asset_name: macos
          - os: windows-latest
            asset_name: windows

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build CLI
      run: |
        make cli

    - name: Package CLI
      run: |
        mkdir -p dist
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          mv bin/cisv dist/cisv-${{ matrix.asset_name }}.exe
        else
          mv bin/cisv dist/cisv-${{ matrix.asset_name }}
        fi

    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        name: cisv-${{ matrix.asset_name }}
        path: dist/cisv-${{ matrix.asset_name }}*

  publish-npm:
    runs-on: ubuntu-latest
    needs: release
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '23.x'
        registry-url: 'https://registry.npmjs.org'

    - name: Publish to npm
      run: |
        cd bindings/node
        npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-pypi:
    runs-on: ubuntu-latest
    needs: release
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Publish to PyPI
      run: |
        cd bindings/python
        python -m pip install --upgrade build twine
        python -m build
        python -m twine upload dist/*
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  publish-php:
    runs-on: ubuntu-latest
    needs: release
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'

    - name: Package PHP extension
      run: |
        cd bindings/php
        phpize
        ./configure
        make
        mkdir -p package
        cp modules/cisv.so package/
        cp LICENSE package/
        tar -czf cisv-php.tar.gz package/

    - name: Upload PHP extension
      uses: actions/upload-artifact@v4
      with:
        name: cisv-php
        path: bindings/php/cisv-php.tar.gz
